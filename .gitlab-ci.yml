image: voipbin/gitlab-runner:latest

variables:

stages:
  - build
  - release

.gcp_init: &gcp_init |-
  echo $LOCAL_CREDENTIAL > ./google_service_account.json
  gcloud auth activate-service-account --key-file=./google_service_account.json
  gcloud config set project $LOCAL_PROJECTID
  gcloud container clusters get-credentials $LOCAL_CLUSTER_NAME --zone $LOCAL_ZONE --project $LOCAL_PROJECTID

build:
  stage: build
  image: gitlab/dind:latest
  script:
    - docker login -u $CI_REGISTRY_USER -p $CI_REGISTRY_PASSWORD $CI_REGISTRY
    - docker build --tag $CI_REGISTRY_IMAGE:$CI_COMMIT_SHA --tag $CI_REGISTRY_IMAGE:latest .
    - docker push $CI_REGISTRY_IMAGE:$CI_COMMIT_SHA
    - docker push $CI_REGISTRY_IMAGE:latest

release:
  stage: release
  # only:
  #   - master
  when: manual
  dependencies:
    - build
  script:
    - *gcp_init
    - cd k8s
    - kustomize edit set image asterisk-image=$CI_REGISTRY_IMAGE:$CI_COMMIT_SHA
    - kustomize edit set image asterisk-proxy-image=registry.gitlab.com/voipbin/voip/asterisk-proxy:0d9a92a461df07f347e7a0d8a45874174585c5d5
    - kustomize edit set image transcribe-agent-image=registry.gitlab.com/voipbin/bin-manager/transcribe-agent:a1e76b26ca314fe3a94a0736bdeb3b8af795d4fc
    - kubectl apply -k ./ -v6
  variables:
    LOCAL_CREDENTIAL: $GL_GCP_CREDENTIAL
    LOCAL_PROJECTID: voipbin-production
    LOCAL_CLUSTER_NAME: k8s-cluster-production
    LOCAL_ZONE: europe-west4-a
