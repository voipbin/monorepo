version: 2.1

context_production: &context_production
  context: 
    - production

references:
  go_image: &go_image
    - image: cimg/go:1.25.3
  gcp_image: &gcp_image
    - image: cimg/gcp:2024.03
  gcloud_image: &gcloud_image
    - image: google/cloud-sdk:debian_component_based


parameters:

  ############################################
  # namespace: bin
  ############################################

  run-bin-agent-manager:
    type: boolean
    default: false

  run-bin-api-manager:
    type: boolean
    default: false

  run-bin-billing-manager:
    type: boolean
    default: false

  run-bin-call-manager:
    type: boolean
    default: false

  run-bin-campaign-manager:
    type: boolean
    default: false

  run-bin-ai-manager:
    type: boolean
    default: false

  run-bin-common-handler:
    type: boolean
    default: false

  run-bin-contact-manager:
    type: boolean
    default: false

  run-bin-conference-manager:
    type: boolean
    default: false

  run-bin-conversation-manager:
    type: boolean
    default: false

  run-bin-customer-manager:
    type: boolean
    default: false

  run-bin-dbscheme-manager:
    type: boolean
    default: false

  run-bin-email-manager:
    type: boolean
    default: false

  run-bin-flow-manager:
    type: boolean
    default: false

  run-bin-hook-manager:
    type: boolean
    default: false

  run-bin-message-manager:
    type: boolean
    default: false

  run-bin-number-manager:
    type: boolean
    default: false

  run-bin-openapi-manager:
    type: boolean
    default: false

  run-bin-outdial-manager:
    type: boolean
    default: false

  run-bin-pipecat-manager:
    type: boolean
    default: false

  run-bin-queue-manager:
    type: boolean
    default: false

  run-bin-rag-manager:
    type: boolean
    default: false

  run-bin-registrar-manager:
    type: boolean
    default: false

  run-bin-route-manager:
    type: boolean
    default: false

  run-bin-sentinel-manager:
    type: boolean
    default: false

  run-bin-storage-manager:
    type: boolean
    default: false

  run-bin-tag-manager:
    type: boolean
    default: false

  run-bin-talk-manager:
    type: boolean
    default: false

  run-bin-timeline-manager:
    type: boolean
    default: false

  run-bin-transcribe-manager:
    type: boolean
    default: false

  run-bin-transfer-manager:
    type: boolean
    default: false

  run-bin-tts-manager:
    type: boolean
    default: false

  run-bin-webhook-manager:
    type: boolean
    default: false

  ############################################
  # namespace: voip
  ############################################
  run-voip-asterisk-proxy:
    type: boolean
    default: false


#########################################################################################################################################################################
# workflows
#########################################################################################################################################################################
workflows:
  ############################################
  # namespace: bin
  ############################################

  bin-agent-manager:
    when: << pipeline.parameters.run-bin-agent-manager >>
    jobs:
      - build-approval:
          type: approval
      - bin-agent-manager-test:
          requires:
            - build-approval
      - bin-agent-manager-build:
          <<: *context_production
          requires:
            - bin-agent-manager-test
      - bin-agent-manager-release:
          <<: *context_production
          requires:
            - bin-agent-manager-build

  bin-api-manager:
    when:
      or: [<< pipeline.parameters.run-bin-api-manager >>, << pipeline.parameters.run-bin-openapi-manager >>]
    jobs:
      - build-approval:
          type: approval
      - bin-api-manager-test:
          requires:
            - build-approval
      - bin-api-manager-build:
          <<: *context_production
          requires:
            - bin-api-manager-test
      - bin-api-manager-release:
          <<: *context_production
          requires:
            - bin-api-manager-build

  bin-billing-manager:
    when: << pipeline.parameters.run-bin-billing-manager >>
    jobs:
      - build-approval:
          type: approval
      - bin-billing-manager-test:
          requires:
            - build-approval
      - bin-billing-manager-build:
          <<: *context_production
          requires:
            - bin-billing-manager-test
      - bin-billing-manager-release:
          <<: *context_production
          requires:
            - bin-billing-manager-build

  bin-call-manager:
    when: << pipeline.parameters.run-bin-call-manager >>
    jobs:
      - build-approval:
          type: approval
      - bin-call-manager-test:
          requires:
            - build-approval
      - bin-call-manager-build:
          <<: *context_production
          requires:
            - bin-call-manager-test
      - bin-call-manager-release:
          <<: *context_production
          requires:
            - bin-call-manager-build

  bin-campaign-manager:
    when: << pipeline.parameters.run-bin-campaign-manager >>
    jobs:
      - build-approval:
          type: approval
      - bin-campaign-manager-test:
          requires:
            - build-approval
      - bin-campaign-manager-build:
          <<: *context_production
          requires:
            - bin-campaign-manager-test
      - bin-campaign-manager-release:
          <<: *context_production
          requires:
            - bin-campaign-manager-build

  bin-ai-manager:
    when: << pipeline.parameters.run-bin-ai-manager >>
    jobs:
      - build-approval:
          type: approval
      - bin-ai-manager-test:
          requires:
            - build-approval
      - bin-ai-manager-build:
          <<: *context_production
          requires:
            - bin-ai-manager-test
      - bin-ai-manager-release:
          <<: *context_production
          requires:
            - bin-ai-manager-build

  bin-common-handler:
    when: << pipeline.parameters.run-bin-common-handler >>
    jobs:
      - build-approval:
          type: approval
      - bin-common-handler-test:
          requires:
            - build-approval

  bin-contact-manager:
    when: << pipeline.parameters.run-bin-contact-manager >>
    jobs:
      - build-approval:
          type: approval
      - bin-contact-manager-test:
          requires:
            - build-approval
      - bin-contact-manager-build:
          <<: *context_production
          requires:
            - bin-contact-manager-test
      - bin-contact-manager-release:
          <<: *context_production
          requires:
            - bin-contact-manager-build

  bin-conference-manager:
    when: << pipeline.parameters.run-bin-conference-manager >>
    jobs:
      - build-approval:
          type: approval
      - bin-conference-manager-test:
          requires:
            - build-approval
      - bin-conference-manager-build:
          <<: *context_production
          requires:
            - bin-conference-manager-test
      - bin-conference-manager-release:
          <<: *context_production
          requires:
            - bin-conference-manager-build

  bin-conversation-manager:
    when: << pipeline.parameters.run-bin-conversation-manager >>
    jobs:
      - build-approval:
          type: approval
      - bin-conversation-manager-test:
          requires:
            - build-approval
      - bin-conversation-manager-build:
          <<: *context_production
          requires:
            - bin-conversation-manager-test
      - bin-conversation-manager-release:
          <<: *context_production
          requires:
            - bin-conversation-manager-build

  bin-customer-manager:
    when: << pipeline.parameters.run-bin-customer-manager >>
    jobs:
      - build-approval:
          type: approval
      - bin-customer-manager-test:
          requires:
            - build-approval
      - bin-customer-manager-build:
          <<: *context_production
          requires:
            - bin-customer-manager-test
      - bin-customer-manager-release:
          <<: *context_production
          requires:
            - bin-customer-manager-build

  bin-dbscheme-manager:
    when: << pipeline.parameters.run-bin-dbscheme-manager >>
    jobs:
      - build-approval:
          type: approval
      - bin-dbscheme-manager-build:
          <<: *context_production
          requires:
            - build-approval

  bin-email-manager:
    when: << pipeline.parameters.run-bin-email-manager >>
    jobs:
      - build-approval:
          type: approval
      - bin-email-manager-test:
          requires:
            - build-approval
      - bin-email-manager-build:
          <<: *context_production
          requires:
            - bin-email-manager-test
      - bin-email-manager-release:
          <<: *context_production
          requires:
            - bin-email-manager-build

  bin-flow-manager:
    when: << pipeline.parameters.run-bin-flow-manager >>
    jobs:
      - build-approval:
          type: approval
      - bin-flow-manager-test:
          requires:
            - build-approval
      - bin-flow-manager-build:
          <<: *context_production
          requires:
            - bin-flow-manager-test
      - bin-flow-manager-release:
          <<: *context_production
          requires:
            - bin-flow-manager-build

  bin-hook-manager:
    when: << pipeline.parameters.run-bin-hook-manager >>
    jobs:
      - build-approval:
          type: approval
      - bin-hook-manager-test:
          requires:
            - build-approval
      - bin-hook-manager-build:
          <<: *context_production
          requires:
            - bin-hook-manager-test
      - bin-hook-manager-release:
          <<: *context_production
          requires:
            - bin-hook-manager-build

  bin-message-manager:
    when: << pipeline.parameters.run-bin-message-manager >>
    jobs:
      - build-approval:
          type: approval
      - bin-message-manager-test:
          requires:
            - build-approval
      - bin-message-manager-build:
          <<: *context_production
          requires:
            - bin-message-manager-test
      - bin-message-manager-release:
          <<: *context_production
          requires:
            - bin-message-manager-build

  bin-number-manager:
    when: << pipeline.parameters.run-bin-number-manager >>
    jobs:
      - build-approval:
          type: approval
      - bin-number-manager-test:
          requires:
            - build-approval
      - bin-number-manager-build:
          <<: *context_production
          requires:
            - bin-number-manager-test
      - bin-number-manager-release:
          <<: *context_production
          requires:
            - bin-number-manager-build

  bin-openapi-manager:
    when: << pipeline.parameters.run-bin-openapi-manager >>
    jobs:
      - build-approval:
          type: approval
      - bin-openapi-manager-validate:
          requires:
            - build-approval

  bin-outdial-manager:
    when: << pipeline.parameters.run-bin-outdial-manager >>
    jobs:
      - build-approval:
          type: approval
      - bin-outdial-manager-test:
          requires:
            - build-approval
      - bin-outdial-manager-build:
          <<: *context_production
          requires:
            - bin-outdial-manager-test
      - bin-outdial-manager-release:
          <<: *context_production
          requires:
            - bin-outdial-manager-build

  bin-pipecat-manager:
    when: << pipeline.parameters.run-bin-pipecat-manager >>
    jobs:
      - build-approval:
          type: approval
      - bin-pipecat-manager-test:
          requires:
            - build-approval
      - bin-pipecat-manager-build:
          <<: *context_production
          requires:
            - bin-pipecat-manager-test
      - bin-pipecat-manager-release:
          <<: *context_production
          requires:
            - bin-pipecat-manager-build

  bin-queue-manager:
    when: << pipeline.parameters.run-bin-queue-manager >>
    jobs:
      - build-approval:
          type: approval
      - bin-queue-manager-test:
          requires:
            - build-approval
      - bin-queue-manager-build:
          <<: *context_production
          requires:
            - bin-queue-manager-test
      - bin-queue-manager-release:
          <<: *context_production
          requires:
            - bin-queue-manager-build

  bin-rag-manager:
    when: << pipeline.parameters.run-bin-rag-manager >>
    jobs:
      - build-approval:
          type: approval
      - bin-rag-manager-test:
          requires:
            - build-approval
      - bin-rag-manager-build:
          <<: *context_production
          requires:
            - bin-rag-manager-test
      - bin-rag-manager-release:
          <<: *context_production
          requires:
            - bin-rag-manager-build

  bin-registrar-manager:
    when: << pipeline.parameters.run-bin-registrar-manager >>
    jobs:
      - build-approval:
          type: approval
      - bin-registrar-manager-test:
          requires:
            - build-approval
      - bin-registrar-manager-build:
          <<: *context_production
          requires:
            - bin-registrar-manager-test
      - bin-registrar-manager-release:
          <<: *context_production
          requires:
            - bin-registrar-manager-build

  bin-route-manager:
    when: << pipeline.parameters.run-bin-route-manager >>
    jobs:
      - build-approval:
          type: approval
      - bin-route-manager-test:
          requires:
            - build-approval
      - bin-route-manager-build:
          <<: *context_production
          requires:
            - bin-route-manager-test
      - bin-route-manager-release:
          <<: *context_production
          requires:
            - bin-route-manager-build

  bin-sentinel-manager:
    when: << pipeline.parameters.run-bin-sentinel-manager >>
    jobs:
      - build-approval:
          type: approval
      - bin-sentinel-manager-test:
          requires:
            - build-approval
      - bin-sentinel-manager-build:
          <<: *context_production
          requires:
            - bin-sentinel-manager-test
      - bin-sentinel-manager-release:
          <<: *context_production
          requires:
            - bin-sentinel-manager-build

  bin-storage-manager:
    when: << pipeline.parameters.run-bin-storage-manager >>
    jobs:
      - build-approval:
          type: approval
      - bin-storage-manager-test:
          requires:
            - build-approval
      - bin-storage-manager-build:
          <<: *context_production
          requires:
            - bin-storage-manager-test
      - bin-storage-manager-release:
          <<: *context_production
          requires:
            - bin-storage-manager-build

  bin-tag-manager:
    when: << pipeline.parameters.run-bin-tag-manager >>
    jobs:
      - build-approval:
          type: approval
      - bin-tag-manager-test:
          requires:
            - build-approval
      - bin-tag-manager-build:
          <<: *context_production
          requires:
            - bin-tag-manager-test
      - bin-tag-manager-release:
          <<: *context_production
          requires:
            - bin-tag-manager-build

  bin-talk-manager:
    when: << pipeline.parameters.run-bin-talk-manager >>
    jobs:
      - build-approval:
          type: approval
      - bin-talk-manager-test:
          requires:
            - build-approval
      - bin-talk-manager-build:
          <<: *context_production
          requires:
            - bin-talk-manager-test
      - bin-talk-manager-release:
          <<: *context_production
          requires:
            - bin-talk-manager-build

  bin-timeline-manager:
    when: << pipeline.parameters.run-bin-timeline-manager >>
    jobs:
      - build-approval:
          type: approval
      - bin-timeline-manager-test:
          requires:
            - build-approval
      - bin-timeline-manager-build:
          <<: *context_production
          requires:
            - bin-timeline-manager-test
      - bin-timeline-manager-release:
          <<: *context_production
          requires:
            - bin-timeline-manager-build

  bin-transcribe-manager:
    when: << pipeline.parameters.run-bin-transcribe-manager >>
    jobs:
      - build-approval:
          type: approval
      - bin-transcribe-manager-test:
          requires:
            - build-approval
      - bin-transcribe-manager-build:
          <<: *context_production
          requires:
            - bin-transcribe-manager-test
      - bin-transcribe-manager-release:
          <<: *context_production
          requires:
            - bin-transcribe-manager-build

  bin-transfer-manager:
    when: << pipeline.parameters.run-bin-transfer-manager >>
    jobs:
      - build-approval:
          type: approval
      - bin-transfer-manager-test:
          requires:
            - build-approval
      - bin-transfer-manager-build:
          <<: *context_production
          requires:
            - bin-transfer-manager-test
      - bin-transfer-manager-release:
          <<: *context_production
          requires:
            - bin-transfer-manager-build

  bin-tts-manager:
    when: << pipeline.parameters.run-bin-tts-manager >>
    jobs:
      - build-approval:
          type: approval
      - bin-tts-manager-test:
          requires:
            - build-approval
      - bin-tts-manager-build:
          <<: *context_production
          requires:
            - bin-tts-manager-test
      - bin-tts-manager-release:
          <<: *context_production
          requires:
            - bin-tts-manager-build

  bin-webhook-manager:
    when: << pipeline.parameters.run-bin-webhook-manager >>
    jobs:
      - build-approval:
          type: approval
      - bin-webhook-manager-test:
          requires:
            - build-approval
      - bin-webhook-manager-build:
          <<: *context_production
          requires:
            - bin-webhook-manager-test
      - bin-webhook-manager-release:
          <<: *context_production
          requires:
            - bin-webhook-manager-build


  ############################################
  # namespace: voip
  ############################################

  voip-asterisk-proxy:
    when:
      or: [<< pipeline.parameters.run-voip-asterisk-proxy >>]
    jobs:
      - build-approval:
          type: approval
      - voip-asterisk-proxy-build:
          <<: *context_production
          requires:
            - build-approval


#########################################################################################################################################################################
# jobs
#########################################################################################################################################################################
jobs:

  ############################################
  # namespace: bin
  ############################################

  # bin-agent-manager
  bin-agent-manager-test:
    docker: *go_image
    resource_class: small
    steps:
      - go-test:
          source-directory: bin-agent-manager

  bin-agent-manager-build:
    docker: *gcp_image
    resource_class: small
    steps:
      - docker-build:
          source-directory: bin-agent-manager
          project-id: voipbin
          project-repository: bin-agent-manager

  bin-agent-manager-release:
    docker: *gcloud_image
    resource_class: small
    steps:
      - docker-release:
          source-directory: bin-agent-manager
          image-name: agent-manager
          project-id: voipbin
          project-repository: bin-agent-manager

  # bin-api-manager
  bin-api-manager-test:
    docker: *go_image
    resource_class: small
    steps:
      - go-test-api-manager:
          source-directory: bin-api-manager

  bin-api-manager-build:
    docker: *gcp_image
    resource_class: small
    steps:
      - docker-build:
          source-directory: bin-api-manager
          project-id: voipbin
          project-repository: bin-api-manager

  bin-api-manager-release:
    docker: *gcloud_image
    resource_class: small
    steps:
      - docker-release:
          source-directory: bin-api-manager
          image-name: api-manager
          project-id: voipbin
          project-repository: bin-api-manager

  # bin-billing-manager
  bin-billing-manager-test:
    docker: *go_image
    resource_class: small
    steps:
      - go-test:
          source-directory: bin-billing-manager

  bin-billing-manager-build:
    docker: *gcp_image
    resource_class: small
    steps:
      - docker-build:
          source-directory: bin-billing-manager
          project-id: voipbin
          project-repository: bin-billing-manager

  bin-billing-manager-release:
    docker: *gcloud_image
    resource_class: small
    steps:
      - docker-release:
          project-id: voipbin
          project-repository: bin-billing-manager
          image-name: billing-manager
          source-directory: bin-billing-manager

  # bin-call-manager
  bin-call-manager-test:
    docker: *go_image
    resource_class: small
    steps:
      - go-test:
          source-directory: bin-call-manager

  bin-call-manager-build:
    docker: *gcp_image
    resource_class: small
    steps:
      - docker-build:
          source-directory: bin-call-manager
          project-id: voipbin
          project-repository: bin-call-manager

  bin-call-manager-release:
    docker: *gcloud_image
    resource_class: small
    steps:
      - docker-release:
          source-directory: bin-call-manager
          image-name: call-manager
          project-id: voipbin
          project-repository: bin-call-manager

  # bin-campaign-manager
  bin-campaign-manager-test:
    docker: *go_image
    resource_class: small
    steps:
      - go-test:
          source-directory: bin-campaign-manager

  bin-campaign-manager-build:
    docker: *gcp_image
    resource_class: small
    steps:
      - docker-build:
          source-directory: bin-campaign-manager
          project-id: voipbin
          project-repository: bin-campaign-manager

  bin-campaign-manager-release:
    docker: *gcloud_image
    resource_class: small
    steps:
      - docker-release:
          source-directory: bin-campaign-manager
          image-name: campaign-manager
          project-id: voipbin
          project-repository: bin-campaign-manager

  # bin-ai-manager
  bin-ai-manager-test:
    docker: *go_image
    resource_class: small
    steps:
      - go-test:
          source-directory: bin-ai-manager

  bin-ai-manager-build:
    docker: *gcp_image
    resource_class: small
    steps:
      - docker-build:
          source-directory: bin-ai-manager
          project-id: voipbin
          project-repository: bin-ai-manager

  bin-ai-manager-release:
    docker: *gcloud_image
    resource_class: small
    steps:
      - docker-release:
          source-directory: bin-ai-manager
          image-name: ai-manager
          project-id: voipbin
          project-repository: bin-ai-manager

  # bin-common-handler
  bin-common-handler-test:
    docker: *go_image
    resource_class: small
    steps:
      - go-test:
          source-directory: bin-common-handler

  # bin-contact-manager
  bin-contact-manager-test:
    docker: *go_image
    resource_class: small
    steps:
      - go-test:
          source-directory: bin-contact-manager

  bin-contact-manager-build:
    docker: *gcp_image
    resource_class: small
    steps:
      - docker-build:
          source-directory: bin-contact-manager
          project-id: voipbin
          project-repository: bin-contact-manager

  bin-contact-manager-release:
    docker: *gcloud_image
    resource_class: small
    steps:
      - docker-release:
          source-directory: bin-contact-manager
          image-name: contact-manager
          project-id: voipbin
          project-repository: bin-contact-manager

  # bin-conference-manager
  bin-conference-manager-test:
    docker: *go_image
    resource_class: small
    steps:
      - go-test:
          source-directory: bin-conference-manager

  bin-conference-manager-build:
    docker: *gcp_image
    resource_class: small
    steps:
      - docker-build:
          source-directory: bin-conference-manager
          project-id: voipbin
          project-repository: bin-conference-manager

  bin-conference-manager-release:
    docker: *gcloud_image
    resource_class: small
    steps:
      - docker-release:
          source-directory: bin-conference-manager
          image-name: conference-manager
          project-id: voipbin
          project-repository: bin-conference-manager

  # bin-conversation-manager
  bin-conversation-manager-test:
    docker: *go_image
    resource_class: small
    steps:
      - go-test:
          source-directory: bin-conversation-manager

  bin-conversation-manager-build:
    docker: *gcp_image
    resource_class: small
    steps:
      - docker-build:
          source-directory: bin-conversation-manager
          project-id: voipbin
          project-repository: bin-conversation-manager

  bin-conversation-manager-release:
    docker: *gcloud_image
    resource_class: small
    steps:
      - docker-release:
          source-directory: bin-conversation-manager
          image-name: conversation-manager
          project-id: voipbin
          project-repository: bin-conversation-manager

  # bin-customer-manager
  bin-customer-manager-test:
    docker: *go_image
    resource_class: small
    steps:
      - go-test:
          source-directory: bin-customer-manager

  bin-customer-manager-build:
    docker: *gcp_image
    resource_class: small
    steps:
      - docker-build:
          source-directory: bin-customer-manager
          project-id: voipbin
          project-repository: bin-customer-manager

  bin-customer-manager-release:
    docker: *gcloud_image
    resource_class: small
    steps:
      - docker-release:
          source-directory: bin-customer-manager
          image-name: customer-manager
          project-id: voipbin
          project-repository: bin-customer-manager

  # bin-dbscheme-manager
  bin-dbscheme-manager-build:
    docker: *gcp_image
    resource_class: small
    steps:
      - docker-build:
          source-directory: bin-dbscheme-manager
          project-id: voipbin
          project-repository: bin-database

  # bin-email-manager
  bin-email-manager-test:
    docker: *go_image
    resource_class: small
    steps:
      - go-test:
          source-directory: bin-email-manager

  bin-email-manager-build:
    docker: *gcp_image
    resource_class: small
    steps:
      - docker-build:
          source-directory: bin-email-manager
          project-id: voipbin
          project-repository: bin-email-manager

  bin-email-manager-release:
    docker: *gcloud_image
    resource_class: small
    steps:
      - docker-release:
          source-directory: bin-email-manager
          image-name: email-manager
          project-id: voipbin
          project-repository: bin-email-manager

  # bin-flow-manager
  bin-flow-manager-test:
    docker: *go_image
    resource_class: small
    steps:
      - go-test:
          source-directory: bin-flow-manager

  bin-flow-manager-build:
    docker: *gcp_image
    resource_class: small
    steps:
      - docker-build:
          source-directory: bin-flow-manager
          project-id: voipbin
          project-repository: bin-flow-manager

  bin-flow-manager-release:
    docker: *gcloud_image
    resource_class: small
    steps:
      - docker-release:
          source-directory: bin-flow-manager
          image-name: flow-manager
          project-id: voipbin
          project-repository: bin-flow-manager

  # bin-hook-manager
  bin-hook-manager-test:
    docker: *go_image
    resource_class: small
    steps:
      - go-test:
          source-directory: bin-hook-manager

  bin-hook-manager-build:
    docker: *gcp_image
    resource_class: small
    steps:
      - docker-build:
          source-directory: bin-hook-manager
          project-id: voipbin
          project-repository: bin-hook-manager

  bin-hook-manager-release:
    docker: *gcloud_image
    resource_class: small
    steps:
      - docker-release:
          source-directory: bin-hook-manager
          image-name: hook-manager
          project-id: voipbin
          project-repository: bin-hook-manager

  # bin-message-manager
  bin-message-manager-test:
    docker: *go_image
    resource_class: small
    steps:
      - go-test:
          source-directory: bin-message-manager

  bin-message-manager-build:
    docker: *gcp_image
    resource_class: small
    steps:
      - docker-build:
          project-id: voipbin
          project-repository: bin-message-manager
          source-directory: bin-message-manager

  bin-message-manager-release:
    docker: *gcloud_image
    resource_class: small
    steps:
      - docker-release:
          project-id: voipbin
          project-repository: bin-message-manager
          source-directory: bin-message-manager
          image-name: message-manager

  # bin-number-manager
  bin-number-manager-test:
    docker: *go_image
    resource_class: small
    steps:
      - go-test:
          source-directory: bin-number-manager

  bin-number-manager-build:
    docker: *gcp_image
    resource_class: small
    steps:
      - docker-build:
          project-id: voipbin
          project-repository: bin-number-manager
          source-directory: bin-number-manager

  bin-number-manager-release:
    docker: *gcloud_image
    resource_class: small
    steps:
      - docker-release:
          project-id: voipbin
          project-repository: bin-number-manager
          source-directory: bin-number-manager
          image-name: number-manager

  # bin-openapi-manager
  bin-openapi-manager-validate:
    docker: *go_image
    resource_class: small
    steps:
      - checkout
      - run:
          name: Install dependencies
          command: |
            cd bin-openapi-manager
            go mod download
            go mod vendor
      - run:
          name: Validate OpenAPI spec syntax
          command: |
            cd bin-openapi-manager
            go install github.com/oapi-codegen/oapi-codegen/v2/cmd/oapi-codegen@latest
            oapi-codegen -config configs/config_model/config.generate.yaml openapi/openapi.yaml > /dev/null
      - run:
          name: Verify generated models match committed
          command: |
            cd bin-openapi-manager
            go generate ./...
            if ! git diff --exit-code gens/models/gen.go; then
              echo "ERROR: Generated models differ from committed. Run 'go generate ./...' and commit changes."
              exit 1
            fi

  # bin-outdial-manager
  bin-outdial-manager-test:
    docker: *go_image
    resource_class: small
    steps:
      - go-test:
          source-directory: bin-outdial-manager

  bin-outdial-manager-build:
    docker: *gcp_image
    resource_class: small
    steps:
      - docker-build:
          project-id: voipbin
          project-repository: bin-outdial-manager
          source-directory: bin-outdial-manager

  bin-outdial-manager-release:
    docker: *gcloud_image
    resource_class: small
    steps:
      - docker-release:
          project-id: voipbin
          project-repository: bin-outdial-manager
          source-directory: bin-outdial-manager
          image-name: outdial-manager

  # bin-pipecat-manager
  bin-pipecat-manager-test:
    docker: *go_image
    resource_class: small
    steps:
      - go-test-pipecat-manager:
          source-directory: bin-pipecat-manager

  bin-pipecat-manager-build:
    docker: *gcp_image
    resource_class: small
    steps:
      - docker-build:
          project-id: voipbin
          project-repository: bin-pipecat-manager
          source-directory: bin-pipecat-manager

  bin-pipecat-manager-release:
    docker: *gcloud_image
    resource_class: small
    steps:
      - docker-release:
          project-id: voipbin
          project-repository: bin-pipecat-manager
          source-directory: bin-pipecat-manager
          image-name: pipecat-manager

  # bin-queue-manager
  bin-queue-manager-test:
    docker: *go_image
    resource_class: small
    steps:
      - go-test:
          source-directory: bin-queue-manager

  bin-queue-manager-build:
    docker: *gcp_image
    resource_class: small
    steps:
      - docker-build:
          project-id: voipbin
          project-repository: bin-queue-manager
          source-directory: bin-queue-manager

  bin-queue-manager-release:
    docker: *gcloud_image
    resource_class: small
    steps:
      - docker-release:
          project-id: voipbin
          project-repository: bin-queue-manager
          image-name: queue-manager
          source-directory: bin-queue-manager

  # bin-rag-manager
  bin-rag-manager-test:
    docker: *go_image
    resource_class: small
    steps:
      - go-test:
          source-directory: bin-rag-manager

  bin-rag-manager-build:
    docker: *gcp_image
    resource_class: small
    steps:
      - docker-build:
          source-directory: bin-rag-manager
          project-id: voipbin
          project-repository: bin-rag-manager

  bin-rag-manager-release:
    docker: *gcloud_image
    resource_class: small
    steps:
      - docker-release:
          source-directory: bin-rag-manager
          image-name: rag-manager
          project-id: voipbin
          project-repository: bin-rag-manager

  # bin-registrar-manager
  bin-registrar-manager-test:
    docker: *go_image
    resource_class: small
    steps:
      - go-test:
          source-directory: bin-registrar-manager

  bin-registrar-manager-build:
    docker: *gcp_image
    resource_class: small
    steps:
      - docker-build:
          project-id: voipbin
          project-repository: bin-registrar-manager
          source-directory: bin-registrar-manager

  bin-registrar-manager-release:
    docker: *gcloud_image
    resource_class: small
    steps:
      - docker-release:
          project-id: voipbin
          project-repository: bin-registrar-manager
          source-directory: bin-registrar-manager
          image-name: registrar-manager

  # bin-route-manager
  bin-route-manager-test:
    docker: *go_image
    resource_class: small
    steps:
      - go-test:
          source-directory: bin-route-manager

  bin-route-manager-build:
    docker: *gcp_image
    resource_class: small
    steps:
      - docker-build:
          project-id: voipbin
          project-repository: bin-route-manager
          source-directory: bin-route-manager

  bin-route-manager-release:
    docker: *gcloud_image
    resource_class: small
    steps:
      - docker-release:
          project-id: voipbin
          project-repository: bin-route-manager
          source-directory: bin-route-manager
          image-name: route-manager

  # bin-sentinel-manager
  bin-sentinel-manager-test:
    docker: *go_image
    resource_class: small
    steps:
      - go-test:
          source-directory: bin-sentinel-manager

  bin-sentinel-manager-build:
    docker: *gcp_image
    resource_class: small
    steps:
      - docker-build:
          project-id: voipbin
          project-repository: bin-sentinel-manager
          source-directory: bin-sentinel-manager

  bin-sentinel-manager-release:
    docker: *gcloud_image
    resource_class: small
    steps:
      - docker-release:
          project-id: voipbin
          project-repository: bin-sentinel-manager
          image-name: sentinel-manager
          source-directory: bin-sentinel-manager

  # bin-storage-manager
  bin-storage-manager-test:
    docker: *go_image
    resource_class: small
    steps:
      - go-test:
          source-directory: bin-storage-manager

  bin-storage-manager-build:
    docker: *gcp_image
    resource_class: small
    steps:
      - docker-build:
          project-id: voipbin
          project-repository: bin-storage-manager
          source-directory: bin-storage-manager

  bin-storage-manager-release:
    docker: *gcloud_image
    resource_class: small
    steps:
      - docker-release:
          project-id: voipbin
          project-repository: bin-storage-manager
          source-directory: bin-storage-manager
          image-name: storage-manager

  # bin-tag-manager
  bin-tag-manager-test:
    docker: *go_image
    resource_class: small
    steps:
      - go-test:
          source-directory: bin-tag-manager

  bin-tag-manager-build:
    docker: *gcp_image
    resource_class: small
    steps:
      - docker-build:
          project-id: voipbin
          project-repository: bin-tag-manager
          source-directory: bin-tag-manager

  bin-tag-manager-release:
    docker: *gcloud_image
    resource_class: small
    steps:
      - docker-release:
          project-id: voipbin
          project-repository: bin-tag-manager
          image-name: tag-manager
          source-directory: bin-tag-manager

  # bin-talk-manager
  bin-talk-manager-test:
    docker: *go_image
    resource_class: small
    steps:
      - go-test:
          source-directory: bin-talk-manager

  bin-talk-manager-build:
    docker: *gcp_image
    resource_class: small
    steps:
      - docker-build:
          project-id: voipbin
          project-repository: bin-talk-manager
          source-directory: bin-talk-manager

  bin-talk-manager-release:
    docker: *gcloud_image
    resource_class: small
    steps:
      - docker-release:
          project-id: voipbin
          project-repository: bin-talk-manager
          image-name: talk-manager
          source-directory: bin-talk-manager

  # bin-timeline-manager
  bin-timeline-manager-test:
    docker: *go_image
    resource_class: small
    steps:
      - go-test:
          source-directory: bin-timeline-manager

  bin-timeline-manager-build:
    docker: *gcp_image
    resource_class: small
    steps:
      - docker-build:
          project-id: voipbin
          project-repository: bin-timeline-manager
          source-directory: bin-timeline-manager

  bin-timeline-manager-release:
    docker: *gcloud_image
    resource_class: small
    steps:
      - docker-release:
          project-id: voipbin
          project-repository: bin-timeline-manager
          image-name: timeline-manager
          source-directory: bin-timeline-manager

  # bin-transcribe-manager
  bin-transcribe-manager-test:
    docker: *go_image
    resource_class: small
    steps:
      - go-test:
          source-directory: bin-transcribe-manager

  bin-transcribe-manager-build:
    docker: *gcp_image
    resource_class: small
    steps:
      - docker-build:
          project-id: voipbin
          project-repository: bin-transcribe-manager
          source-directory: bin-transcribe-manager

  bin-transcribe-manager-release:
    docker: *gcloud_image
    resource_class: small
    steps:
      - docker-release:
          project-id: voipbin
          project-repository: bin-transcribe-manager
          source-directory: bin-transcribe-manager
          image-name: transcribe-manager

  # bin-transfer-manager
  bin-transfer-manager-test:
    docker: *go_image
    resource_class: small
    steps:
      - go-test:
          source-directory: bin-transfer-manager

  bin-transfer-manager-build:
    docker: *gcp_image
    resource_class: small
    steps:
      - docker-build:
          project-id: voipbin
          project-repository: bin-transfer-manager
          source-directory: bin-transfer-manager

  bin-transfer-manager-release:
    docker: *gcloud_image
    resource_class: small
    steps:
      - docker-release:
          project-id: voipbin
          project-repository: bin-transfer-manager
          image-name: transfer-manager
          source-directory: bin-transfer-manager

  # bin-tts-manager
  bin-tts-manager-test:
    docker: *go_image
    resource_class: small
    steps:
      - go-test:
          source-directory: bin-tts-manager

  bin-tts-manager-build:
    docker: *gcp_image
    resource_class: small
    steps:
      - docker-build:
          project-id: voipbin
          project-repository: bin-tts-manager
          source-directory: bin-tts-manager

  bin-tts-manager-release:
    docker: *gcloud_image
    resource_class: small
    steps:
      - docker-release:
          project-id: voipbin
          project-repository: bin-tts-manager
          image-name: tts-manager
          source-directory: bin-tts-manager

  # bin-webhook-manager
  bin-webhook-manager-test:
    docker: *go_image
    resource_class: small
    steps:
      - go-test:
          source-directory: bin-webhook-manager

  bin-webhook-manager-build:
    docker: *gcp_image
    resource_class: small
    steps:
      - docker-build:
          project-id: voipbin
          project-repository: bin-webhook-manager
          source-directory: bin-webhook-manager

  bin-webhook-manager-release:
    docker: *gcloud_image
    resource_class: small
    steps:
      - docker-release:
          project-id: voipbin
          project-repository: bin-webhook-manager
          source-directory: bin-webhook-manager
          image-name: webhook-manager

  ############################################
  # namespace: voip
  ############################################

  # voip-asterisk-proxy
  voip-asterisk-proxy-build:
    docker: *gcp_image
    resource_class: small
    steps:
      - docker-build:
          project-id: voipbin
          project-repository: voip-asterisk-proxy
          source-directory: voip-asterisk-proxy


#########################################################################################################################################################################
# commands
#########################################################################################################################################################################
commands:
  go-test:
    description: "test and lint the go application"
    parameters:
      source-directory:
        type: string
        default: "none"
    steps:
      - run: echo working on << parameters.source-directory >>
      - checkout
      - run:
          name: Install dependencies and vendor
          command: |
            cd << parameters.source-directory >>
            go mod download
            go mod vendor
      # TODO: Re-enable golangci-lint after fixing OOM on small resource_class
      # - run:
      #     name: Install golangci-lint v2.5.0
      #     command: |
      #       curl -sSfL https://raw.githubusercontent.com/golangci/golangci-lint/master/install.sh | sh -s v2.5.0
      #       sudo mv ./bin/golangci-lint /usr/local/bin/
      #       golangci-lint version
      # - run:
      #     name: Linting and vet
      #     command: |
      #       cd << parameters.source-directory >>
      #       golangci-lint run -v --timeout 5m
      #       go vet $(go list ./...)
      - run:
          name: Testing
          command: |
            cd << parameters.source-directory >>
            go test -coverprofile cp.out -v $(go list ./...)
            go tool cover -html=cp.out -o cp.html
            go tool cover -func=cp.out
      - run:
          name: Run gotestsum
          command: |
            cd << parameters.source-directory >>
            gotestsum --junitfile test-results.xml
      - store_test_results:
          path: << parameters.source-directory >>/test-results.xml

  go-test-api-manager:
    description: "test and lint the go application"
    parameters:
      source-directory:
        type: string
        default: "none"
    steps:
      - run: echo working on << parameters.source-directory >>
      - checkout
      - run:
          name: Install dependencies and vendor
          command: |
            cd << parameters.source-directory >>
            go mod download
            go mod vendor
      - run:
          name: Install extra dependencies
          command: |
            sudo apt-get update && sudo apt install -y pkg-config libzmq5 libzmq3-dev libczmq4 libczmq-dev
      # TODO: Re-enable golangci-lint after fixing OOM on small resource_class
      # - run:
      #     name: Install golangci-lint v2.5.0
      #     command: |
      #       curl -sSfL https://raw.githubusercontent.com/golangci/golangci-lint/master/install.sh | sh -s v2.5.0
      #       sudo mv ./bin/golangci-lint /usr/local/bin/
      #       golangci-lint version
      # - run:
      #     name: Linting and vet
      #     command: |
      #       cd << parameters.source-directory >>
      #       golangci-lint run -v --timeout 5m
      #       go vet $(go list ./...)
      - run:
          name: Testing
          command: |
            cd << parameters.source-directory >>
            go test -coverprofile cp.out -v $(go list ./...)
            go tool cover -html=cp.out -o cp.html
            go tool cover -func=cp.out
      - run:
          name: Run gotestsum
          command: |
            cd << parameters.source-directory >>
            gotestsum --junitfile test-results.xml

      - store_test_results:
          path: << parameters.source-directory >>/test-results.xml

  go-test-pipecat-manager:
    description: "test and lint the go application with libsoxr support"
    parameters:
      source-directory:
        type: string
        default: "none"
    steps:
      - run: echo working on << parameters.source-directory >>
      - checkout
      - run:
          name: Install dependencies and vendor
          command: |
            cd << parameters.source-directory >>
            go mod download
            go mod vendor
      - run:
          name: Install extra dependencies (libsoxr for audio resampling)
          command: |
            sudo apt-get update && sudo apt install -y pkg-config libsoxr-dev
      # TODO: Re-enable golangci-lint after fixing OOM on small resource_class
      # - run:
      #     name: Install golangci-lint v2.5.0
      #     command: |
      #       curl -sSfL https://raw.githubusercontent.com/golangci/golangci-lint/master/install.sh | sh -s v2.5.0
      #       sudo mv ./bin/golangci-lint /usr/local/bin/
      #       golangci-lint version
      # - run:
      #     name: Linting and vet
      #     command: |
      #       cd << parameters.source-directory >>
      #       golangci-lint run -v --timeout 5m
      #       go vet $(go list ./...)
      - run:
          name: Testing
          command: |
            cd << parameters.source-directory >>
            go test -coverprofile cp.out -v $(go list ./...)
            go tool cover -html=cp.out -o cp.html
            go tool cover -func=cp.out
      - run:
          name: Run gotestsum
          command: |
            cd << parameters.source-directory >>
            gotestsum --junitfile test-results.xml
      - store_test_results:
          path: << parameters.source-directory >>/test-results.xml

  docker-build:
    description: "build the docker image"
    parameters:
      source-directory:
        type: string
        default: "none"
      project-id:
        type: string
        default: "none"
      project-repository:
        type: string
        default: "none"

    steps:
      - run: echo working on << parameters.source-directory >>
      - setup_remote_docker:
          docker_layer_caching: false
          size: small
      - checkout
      - run:
          name: Building Docker image
          command: |
            docker login -u $CC_DOCKERHUB_USERNAME -p $CC_DOCKERHUB_PASSWORD
            docker build --tag << parameters.project-id >>/<< parameters.project-repository >>:$CIRCLE_SHA1 -f << parameters.source-directory >>/Dockerfile .
            docker push << parameters.project-id >>/<< parameters.project-repository >>:$CIRCLE_SHA1

            if [ "$CIRCLE_BRANCH" == "main" ]; then
              echo "Branch is main. Pushing latest tag..."
              docker tag << parameters.project-id >>/<< parameters.project-repository >>:$CIRCLE_SHA1 << parameters.project-id >>/<< parameters.project-repository >>:latest
              docker push << parameters.project-id >>/<< parameters.project-repository >>:latest
            else
              echo "Branch is $CIRCLE_BRANCH, skipping latest tag."
            fi

            echo "Image pushed to << parameters.project-id >>/<< parameters.project-repository >>:$CIRCLE_SHA1"

  docker-release:
    description: "release the docker image"
    parameters:
      source-directory:
        type: string
        default: "none"
      image-name:
        type: string
        default: "none"
      project-id:
        type: string
        default: "none"
      project-repository:
        type: string
        default: "none"
    steps:
      - run: echo working on << parameters.source-directory >>
      - checkout
      - run:
          name: Config service account
          command: |
            echo $CC_GCP_SERVICE_ACCOUNT > ./google_service_account.json
            gcloud auth activate-service-account --key-file=./google_service_account.json
            gcloud config set project $CC_GCP_PROJECT_ID
            gcloud container clusters get-credentials $CC_GCP_CLUSTER_NAME --zone $CC_GCP_CLUSTER_ZONE --project $CC_GCP_PROJECT_ID

      - run:
          name: Release
          command: |
            cd << parameters.source-directory >>/k8s
            find . -type f -exec sed -i -e "s|\${AUTHTOKEN_MESSAGEBIRD}|$CC_AUTHTOKEN_MESSAGEBIRD|g" {} +
            find . -type f -exec sed -i -e "s|\${AUTHTOKEN_OPENAI}|$CC_AUTHTOKEN_OPENAI|g" {} +
            find . -type f -exec sed -i -e "s|\${DATABASE_DSN}|$CC_DATABASE_DSN|g" {} +
            find . -type f -exec sed -i -e "s|\${DATABASE_DSN_ASTERISK}|$CC_DATABASE_DSN_ASTERISK|g" {} +
            find . -type f -exec sed -i -e "s|\${GCP_BUCKET_NAME_MEDIA}|$CC_GCP_BUCKET_NAME_MEDIA|g" {} +
            find . -type f -exec sed -i -e "s|\${GCP_BUCKET_NAME_TMP}|$CC_GCP_BUCKET_NAME_TMP|g" {} +
            find . -type f -exec sed -i -e "s|\${GCP_CLUSTER_NAME}|$CC_GCP_CLUSTER_NAME|g" {} +
            find . -type f -exec sed -i -e "s|\${GCP_CLUSTER_REGION}|$CC_GCP_CLUSTER_REGION|g" {} +
            find . -type f -exec sed -i -e "s|\${GCP_CLUSTER_ZONE}|$CC_GCP_CLUSTER_ZONE|g" {} +
            find . -type f -exec sed -i -e "s|\${GCP_PROJECT_ID}|$CC_GCP_PROJECT_ID|g" {} +
            find . -type f -exec sed -i -e "s|\${JWT_KEY}|$CC_JWT_KEY|g" {} +
            find . -type f -exec sed -i -e "s|\${PROMETHEUS_ENDPOINT}|$CC_PROMETHEUS_ENDPOINT|g" {} +
            find . -type f -exec sed -i -e "s|\${PROMETHEUS_LISTEN_ADDRESS}|$CC_PROMETHEUS_LISTEN_ADDRESS|g" {} +
            find . -type f -exec sed -i -e "s|\${RABBITMQ_ADDRESS}|$CC_RABBITMQ_ADDRESS|g" {} +
            find . -type f -exec sed -i -e "s|\${REDIS_ADDRESS}|$CC_REDIS_ADDRESS|g" {} +
            find . -type f -exec sed -i -e "s|\${REDIS_PASSWORD}|$CC_REDIS_PASSWORD|g" {} +
            find . -type f -exec sed -i -e "s|\${REDIS_DATABASE}|$CC_REDIS_DATABASE|g" {} +
            find . -type f -exec sed -i -e "s|\${SSL_PRIVKEY_API_BASE64}|$CC_SSL_PRIVKEY_API_BASE64|g" {} +
            find . -type f -exec sed -i -e "s|\${SSL_CERT_API_BASE64}|$CC_SSL_CERT_API_BASE64|g" {} +
            find . -type f -exec sed -i -e "s|\${SSL_PRIVKEY_HOOK_BASE64}|$CC_SSL_PRIVKEY_HOOK_BASE64|g" {} +
            find . -type f -exec sed -i -e "s|\${SSL_CERT_HOOK_BASE64}|$CC_SSL_CERT_HOOK_BASE64|g" {} +
            find . -type f -exec sed -i -e "s|\${TELNYX_CONNECTION_ID}|$CC_TELNYX_CONNECTION_ID|g" {} +
            find . -type f -exec sed -i -e "s|\${TELNYX_PROFILE_ID}|$CC_TELNYX_PROFILE_ID|g" {} +
            find . -type f -exec sed -i -e "s|\${TELNYX_TOKEN}|$CC_TELNYX_TOKEN|g" {} +
            find . -type f -exec sed -i -e "s|\${TWILIO_SID}|$CC_TWILIO_SID|g" {} +
            find . -type f -exec sed -i -e "s|\${TWILIO_TOKEN}|$CC_TWILIO_TOKEN|g" {} +
            find . -type f -exec sed -i -e "s|\${AWS_ACCESS_KEY}|$CC_AWS_ACCESS_KEY|g" {} +
            find . -type f -exec sed -i -e "s|\${AWS_SECRET_KEY}|$CC_AWS_SECRET_KEY|g" {} +
            find . -type f -exec sed -i -e "s|\${SENDGRID_API_KEY}|$CC_SENDGRID_API_KEY|g" {} +
            find . -type f -exec sed -i -e "s|\${HOMER_API_ADDRESS}|$CC_HOMER_API_ADDRESS|g" {} +
            find . -type f -exec sed -i -e "s|\${HOMER_AUTH_TOKEN}|$CC_HOMER_AUTH_TOKEN|g" {} +
            find . -type f -exec sed -i -e "s|\${HOMER_WHITELIST}|$CC_HOMER_WHITELIST|g" {} +
            find . -type f -exec sed -i -e "s|\${ELEVENLABS_API_KEY}|$CC_ELEVENLABS_API_KEY|g" {} +
            find . -type f -exec sed -i -e "s|\${CARTESIA_API_KEY}|$CC_CARTESIA_API_KEY|g" {} +
            find . -type f -exec sed -i -e "s|\${CLICKHOUSE_ADDRESS}|$CC_CLICKHOUSE_ADDRESS|g" {} +
            find . -type f -exec sed -i -e "s|\${CLICKHOUSE_DATABASE}|$CC_CLICKHOUSE_DATABASE|g" {} +
            find . -type f -exec sed -i -e "s|\${DEEPGRAM_API_KEY}|$CC_DEEPGRAM_API_KEY|g" {} +
            find . -type f -exec sed -i -e "s|\${XAI_API_KEY}|$CC_XAI_API_KEY|g" {} +
            find . -type f -exec sed -i -e "s|\${MAILGUN_API_KEY}|$CC_MAILGUN_API_KEY|g" {} +
            find . -type f -exec sed -i -e "s|\${DOMAIN_NAME_EXTENSION}|$CC_DOMAIN_NAME_EXTENSION|g" {} +
            find . -type f -exec sed -i -e "s|\${DOMAIN_NAME_TRUNK}|$CC_DOMAIN_NAME_TRUNK|g" {} +
            kustomize edit set image << parameters.image-name >>-image=docker.io/<< parameters.project-id >>/<< parameters.project-repository >>:$CIRCLE_SHA1
            kubectl apply -k ./ -v6
